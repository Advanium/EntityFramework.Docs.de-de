---
title: Clientauswertung im Vergleich zur Serverauswertung – EF Core
description: Auswertung von Abfragen mit Entity Framework Core auf dem Client und auf dem Server
author: smitpatel
ms.date: 10/03/2019
ms.assetid: 8b6697cc-7067-4dc2-8007-85d80503d123
uid: core/querying/client-eval
ms.openlocfilehash: 61a9f4d69b78f6cb42f4d367948f93230370d7f2
ms.sourcegitcommit: 7c3939504bb9da3f46bea3443638b808c04227c2
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 09/09/2020
ms.locfileid: "89616471"
---
# <a name="client-vs-server-evaluation"></a><span data-ttu-id="e87e6-103">Clientauswertung im Vergleich zur Serverauswertung</span><span class="sxs-lookup"><span data-stu-id="e87e6-103">Client vs. Server Evaluation</span></span>

<span data-ttu-id="e87e6-104">Im Allgemeinen versucht Entity Framework Core, eine Abfrage auf dem Server möglichst weitgehend auszuwerten.</span><span class="sxs-lookup"><span data-stu-id="e87e6-104">As a general rule, Entity Framework Core attempts to evaluate a query on the server as much as possible.</span></span> <span data-ttu-id="e87e6-105">EF Core konvertiert Teile der Abfrage in Parameter, die auf dem Client ausgewertet werden können.</span><span class="sxs-lookup"><span data-stu-id="e87e6-105">EF Core converts parts of the query into parameters, which it can evaluate on the client side.</span></span> <span data-ttu-id="e87e6-106">Der Rest der Abfrage wird (mitsamt den generierten Parametern) an die Datenbankanbieter übermittelt, um die entsprechende auszuwertende Datenbankabfrage auf dem Server zu ermitteln.</span><span class="sxs-lookup"><span data-stu-id="e87e6-106">The rest of the query (along with the generated parameters) is given to the database provider to determine the equivalent database query to evaluate on the server.</span></span> <span data-ttu-id="e87e6-107">EF Core unterstützt die teilweise Clientauswertung der Projektion auf oberster Ebene (den letzten Aufruf von `Select()`).</span><span class="sxs-lookup"><span data-stu-id="e87e6-107">EF Core supports partial client evaluation in the top-level projection (essentially, the last call to `Select()`).</span></span> <span data-ttu-id="e87e6-108">Wenn die Projektion auf oberster Ebene in der Abfrage nicht auf den Server übersetzt werden kann, ruft EF Core alle erforderlichen Daten vom Server an und wertet die übrigen Teile der Abfrage auf dem Client aus.</span><span class="sxs-lookup"><span data-stu-id="e87e6-108">If the top-level projection in the query can't be translated to the server, EF Core will fetch any required data from the server and evaluate remaining parts of the query on the client.</span></span> <span data-ttu-id="e87e6-109">Wenn EF Core einen Ausdruck ermittelt, der sich außerhalb der Projektion auf oberster Ebene befindet und nicht auf den Server übersetzt werden kann, wird eine Laufzeitausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="e87e6-109">If EF Core detects an expression, in any place other than the top-level projection, which can't be translated to the server, then it throws a runtime exception.</span></span> <span data-ttu-id="e87e6-110">Informationen dazu, wie EF Core ermittelt, was nicht für den Server übersetzt werden kann, finden Sie unter [Funktionsweise von Abfragen](xref:core/querying/how-query-works).</span><span class="sxs-lookup"><span data-stu-id="e87e6-110">See [How queries work](xref:core/querying/how-query-works) to understand how EF Core determines what can't be translated to server.</span></span>

> [!NOTE]
> <span data-ttu-id="e87e6-111">Vor Version 3.0 hat Entity Framework Core die Clientauswertung überall in der Abfrage unterstützt.</span><span class="sxs-lookup"><span data-stu-id="e87e6-111">Prior to version 3.0, Entity Framework Core supported client evaluation anywhere in the query.</span></span> <span data-ttu-id="e87e6-112">Weitere Informationen finden Sie im [Abschnitt zu vorherigen Versionen](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="e87e6-112">For more information, see the [previous versions section](#previous-versions).</span></span>

> [!TIP]
> <span data-ttu-id="e87e6-113">Das in diesem Artikel verwendete [Beispiel](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) finden Sie auf GitHub.</span><span class="sxs-lookup"><span data-stu-id="e87e6-113">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="client-evaluation-in-the-top-level-projection"></a><span data-ttu-id="e87e6-114">Clientauswertung in der Projektion auf oberster Ebene</span><span class="sxs-lookup"><span data-stu-id="e87e6-114">Client evaluation in the top-level projection</span></span>

<span data-ttu-id="e87e6-115">Im folgenden Beispiel wird eine Hilfsmethode verwendet, um URLs für Blogs zu standardisieren, die von einer SQL Server-Datenbank zurückgegeben werden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-115">In the following example, a helper method is used to standardize URLs for blogs, which are returned from a SQL Server database.</span></span> <span data-ttu-id="e87e6-116">Da der SQL Server-Anbieter keinen Einblick darin hat, wie diese Methode implementiert wird, kann sie nicht in SQL übersetzt werden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-116">Since the SQL Server provider has no insight into how this method is implemented, it isn't possible to translate it into SQL.</span></span> <span data-ttu-id="e87e6-117">Alle anderen Aspekte der Abfrage werden in der Datenbank ausgewertet. Die Rückgabe der `URL` über diese Methode erfolgt jedoch über den Client.</span><span class="sxs-lookup"><span data-stu-id="e87e6-117">All other aspects of the query are evaluated in the database, but passing the returned `URL` through this method is done on the client.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientMethod)]

## <a name="unsupported-client-evaluation"></a><span data-ttu-id="e87e6-118">Nicht unterstützte Clientauswertung</span><span class="sxs-lookup"><span data-stu-id="e87e6-118">Unsupported client evaluation</span></span>

<span data-ttu-id="e87e6-119">Obwohl die Clientauswertung nützlich ist, kann sie manchmal zu Leistungseinbußen führen.</span><span class="sxs-lookup"><span data-stu-id="e87e6-119">While client evaluation is useful, it can result in poor performance sometimes.</span></span> <span data-ttu-id="e87e6-120">Betrachten Sie die folgende Abfrage, in der die Hilfsmethode nun in einem Where-Filter verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="e87e6-120">Consider the following query, in which the helper method is now used in a where filter.</span></span> <span data-ttu-id="e87e6-121">Da der Filter nicht in der Datenbank angewendet werden kann, müssen alle Daten in den Arbeitsspeicher gepullt werden, um den Filter auf den Client anzuwenden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-121">Because the filter can't be applied in the database, all the data needs to be pulled into memory to apply the filter on the client.</span></span> <span data-ttu-id="e87e6-122">Basierend auf dem Filter und der Menge der Daten auf dem Server, könnte die Clientauswertung zu Leistungseinbußen führen.</span><span class="sxs-lookup"><span data-stu-id="e87e6-122">Based on the filter and the amount of data on the server, client evaluation could result in poor performance.</span></span> <span data-ttu-id="e87e6-123">Daher blockiert Entity Framework Core diese Clientauswertung und löst eine Laufzeitausnahme aus.</span><span class="sxs-lookup"><span data-stu-id="e87e6-123">So Entity Framework Core blocks such client evaluation and throws a runtime exception.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientWhere)]

## <a name="explicit-client-evaluation"></a><span data-ttu-id="e87e6-124">Explizite Clientauswertung</span><span class="sxs-lookup"><span data-stu-id="e87e6-124">Explicit client evaluation</span></span>

<span data-ttu-id="e87e6-125">In bestimmten Fällen müssen Sie die Clientauswertung explizit erzwingen, zum Beispiel in den folgenden:</span><span class="sxs-lookup"><span data-stu-id="e87e6-125">You may need to force into client evaluation explicitly in certain cases like following</span></span>

- <span data-ttu-id="e87e6-126">Wenn die Menge der Daten so klein ist, dass die Auswertung auf dem Client zu keinen großen Leistungseinbußen führt.</span><span class="sxs-lookup"><span data-stu-id="e87e6-126">The amount of data is small so that evaluating on the client doesn't incur a huge performance penalty.</span></span>
- <span data-ttu-id="e87e6-127">Wenn der verwendete LINQ-Operator über keine serverseitige Übersetzung verfügt.</span><span class="sxs-lookup"><span data-stu-id="e87e6-127">The LINQ operator being used has no server-side translation.</span></span>

<span data-ttu-id="e87e6-128">In solchen Fällen können Sie die Clientauswertung explizit aktivieren, indem Sie Methoden wie `AsEnumerable` oder `ToList` (`AsAsyncEnumerable` oder `ToListAsync` bei asynchronen Abfragen) aufrufen.</span><span class="sxs-lookup"><span data-stu-id="e87e6-128">In such cases, you can explicitly opt into client evaluation by calling methods like `AsEnumerable` or `ToList` (`AsAsyncEnumerable` or `ToListAsync` for async).</span></span> <span data-ttu-id="e87e6-129">Wenn Sie `AsEnumerable` verwenden, würden Sie die Ergebnisse streamen. Wenn Sie jedoch `ToList` verwenden, würde eine Pufferung verursacht werden, indem eine Liste erstellt wird, was ebenfalls zusätzlichen Arbeitsspeicher erfordert.</span><span class="sxs-lookup"><span data-stu-id="e87e6-129">By using `AsEnumerable` you would be streaming the results, but using `ToList` would cause buffering by creating a list, which also takes additional memory.</span></span> <span data-ttu-id="e87e6-130">Wenn Sie jedoch mehrere Aufzählungen durchführen, ist das Speichern der Ergebnisse in einer Liste hilfreicher, da die Datenbank nur einmal abgefragt wird.</span><span class="sxs-lookup"><span data-stu-id="e87e6-130">Though if you're enumerating multiple times, then storing results in a list helps more since there's only one query to the database.</span></span> <span data-ttu-id="e87e6-131">Abhängig von der jeweiligen Nutzung sollten Sie auswerten, welche Methode sich am besten eignet.</span><span class="sxs-lookup"><span data-stu-id="e87e6-131">Depending on the particular usage, you should evaluate which method is more useful for the case.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ExplicitClientEval)]

## <a name="potential-memory-leak-in-client-evaluation"></a><span data-ttu-id="e87e6-132">Potenzieller Arbeitsspeicherverlust bei der Clientauswertung</span><span class="sxs-lookup"><span data-stu-id="e87e6-132">Potential memory leak in client evaluation</span></span>

<span data-ttu-id="e87e6-133">Da die Übersetzung und Kompilierung von Abfragen leistungsintensiv ist, wird der kompilierte Abfrageplan von EF Core zwischengespeichert.</span><span class="sxs-lookup"><span data-stu-id="e87e6-133">Since query translation and compilation are expensive, EF Core caches the compiled query plan.</span></span> <span data-ttu-id="e87e6-134">Der zwischengespeicherte Delegat kann Clientcode während der Clientauswertung der Projektion auf oberster Ebene verwenden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-134">The cached delegate may use client code while doing client evaluation of top-level projection.</span></span> <span data-ttu-id="e87e6-135">EF Core generiert Parameter für die vom Client ausgewerteten Teile der Struktur und verwendet den Abfrageplan erneut, indem die Parameterwerte ersetzt werden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-135">EF Core generates parameters for the client-evaluated parts of the tree and reuses the query plan by replacing the parameter values.</span></span> <span data-ttu-id="e87e6-136">Gewisse Konstanten in der Ausdrucksbaumstruktur können jedoch nicht in Parameter konvertiert werden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-136">But certain constants in the expression tree can't be converted into parameters.</span></span> <span data-ttu-id="e87e6-137">Wenn der zwischengespeicherte Delegat solche Konstanten enthält, kann keine Garbage Collection für diese Objekte durchgeführt werden, da immer noch auf sie verwiesen wird.</span><span class="sxs-lookup"><span data-stu-id="e87e6-137">If the cached delegate contains such constants, then those objects can't be garbage collected since they're still being referenced.</span></span> <span data-ttu-id="e87e6-138">Wenn ein solches Objekt eine DbContext-Instanz oder andere Dienste enthält, würde die Arbeitsspeichernutzung der App mit der Zeit wachsen.</span><span class="sxs-lookup"><span data-stu-id="e87e6-138">If such an object contains a DbContext or other services in it, then it could cause the memory usage of the app to grow over time.</span></span> <span data-ttu-id="e87e6-139">In der Regel ist dieses Verhalten ein Anzeichen für Arbeitsspeicherverlust.</span><span class="sxs-lookup"><span data-stu-id="e87e6-139">This behavior is generally a sign of a memory leak.</span></span> <span data-ttu-id="e87e6-140">EF Core löst eine Ausnahme aus, wenn Konstanten eines Typs ermittelt werden, die nicht mithilfe des aktuellen Datenbankanbieters zugeordnet werden können.</span><span class="sxs-lookup"><span data-stu-id="e87e6-140">EF Core throws an exception whenever it comes across constants of a type that can't be mapped using current database provider.</span></span> <span data-ttu-id="e87e6-141">Häufige Gründe und Lösungen lauten wie folgt:</span><span class="sxs-lookup"><span data-stu-id="e87e6-141">Common causes and their solutions are as follows:</span></span>

- <span data-ttu-id="e87e6-142">**Verwendung einer Instanzmethode:** Wenn Instanzmethoden in einer Clientprojektion verwendet werden, enthält die Ausdrucksbaumstruktur eine Konstante der Instanz.</span><span class="sxs-lookup"><span data-stu-id="e87e6-142">**Using an instance method**: When using instance methods in a client projection, the expression tree contains a constant of the instance.</span></span> <span data-ttu-id="e87e6-143">Wenn Ihre Methode keine Daten aus der Instanz verwendet, sollten Sie in Betracht ziehen, die Methode als statisch festzulegen.</span><span class="sxs-lookup"><span data-stu-id="e87e6-143">If your method doesn't use any data from the instance, consider making the method static.</span></span> <span data-ttu-id="e87e6-144">Wenn Sie Instanzdaten in den Methodentext einfügen müssen, übergeben Sie die spezifischen Daten als Argument an die Methode.</span><span class="sxs-lookup"><span data-stu-id="e87e6-144">If you need instance data in the method body, then pass the specific data as an argument to the method.</span></span>
- <span data-ttu-id="e87e6-145">**Übergeben konstanter Argumente an die Methode:** Dieser Fall tritt im Allgemeinen auf, wenn `this` in einem Argument für die Clientmethode verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="e87e6-145">**Passing constant arguments to method**: This case arises generally by using `this` in an argument to client method.</span></span> <span data-ttu-id="e87e6-146">Erwägen Sie, das Argument in mehrere skalare Argumente aufzuteilen, die vom Datenbankanbieter zugeordnet werden können.</span><span class="sxs-lookup"><span data-stu-id="e87e6-146">Consider splitting the argument in to multiple scalar arguments, which can be mapped by the database provider.</span></span>
- <span data-ttu-id="e87e6-147">**Andere Konstanten:** Wenn eine Konstante in einem anderen Fall ermittelt wird, können Sie bestimmen, ob diese Konstante für die Verarbeitung erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="e87e6-147">**Other constants**: If a constant is come across in any other case, then you can evaluate whether the constant is needed in processing.</span></span> <span data-ttu-id="e87e6-148">Wenn die Konstante erforderlich ist oder Sie keine Lösung aus den obigen Fällen verwenden können, erstellen Sie eine lokale Variable, um den Wert zu speichern und die lokale Variable in der Abfrage zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-148">If it's necessary to have the constant, or if you can't use a solution from the above cases, then create a local variable to store the value and use local variable in the query.</span></span> <span data-ttu-id="e87e6-149">EF Core konvertiert die lokale Variable in einen Parameter.</span><span class="sxs-lookup"><span data-stu-id="e87e6-149">EF Core will convert the local variable into a parameter.</span></span>

## <a name="previous-versions"></a><span data-ttu-id="e87e6-150">Frühere Versionen</span><span class="sxs-lookup"><span data-stu-id="e87e6-150">Previous versions</span></span>

<span data-ttu-id="e87e6-151">Der folgende Abschnitt gilt für Versionen von EF Core vor Version 3.0.</span><span class="sxs-lookup"><span data-stu-id="e87e6-151">The following section applies to EF Core versions before 3.0.</span></span>

<span data-ttu-id="e87e6-152">Ältere EF Core-Versionen haben die Clientauswertung in beliebigen Teilen der Abfrage unterstützt, nicht nur in der Projektion auf oberster Ebene.</span><span class="sxs-lookup"><span data-stu-id="e87e6-152">Older EF Core versions supported client evaluation in any part of the query--not just the top-level projection.</span></span> <span data-ttu-id="e87e6-153">Daher haben Abfragen wie die im Abschnitt [Nicht unterstützte Clientauswertung](#unsupported-client-evaluation) ordnungsgemäß funktioniert.</span><span class="sxs-lookup"><span data-stu-id="e87e6-153">That's why queries similar to one posted under the [Unsupported client evaluation](#unsupported-client-evaluation) section worked correctly.</span></span> <span data-ttu-id="e87e6-154">Da dieses Verhalten zu unbemerkten Leistungsproblemen führte, hat EF Core eine Warnung für die Clientauswertung protokolliert.</span><span class="sxs-lookup"><span data-stu-id="e87e6-154">Since this behavior could cause unnoticed performance issues, EF Core logged a client evaluation warning.</span></span> <span data-ttu-id="e87e6-155">Weitere Informationen zum Anzeigen von Protokollierungsausgaben finden Sie unter [Protokollierung](xref:core/miscellaneous/logging).</span><span class="sxs-lookup"><span data-stu-id="e87e6-155">For more information on viewing logging output, see [Logging](xref:core/miscellaneous/logging).</span></span>

<span data-ttu-id="e87e6-156">Optional konnten Sie das Standardverhalten mit EF Core ändern, um bei der Clientauswertung entweder eine Ausnahme auszulösen oder keine Aktion durchzuführen (außer bei der Projektion).</span><span class="sxs-lookup"><span data-stu-id="e87e6-156">Optionally EF Core allowed you to change the default behavior to either throw an exception or do nothing when doing client evaluation (except for in the projection).</span></span> <span data-ttu-id="e87e6-157">Das Verhalten zum Auslösen einer Ausnahme ähnelt dem Verhalten von Version 3.0.</span><span class="sxs-lookup"><span data-stu-id="e87e6-157">The exception throwing behavior would make it similar to the behavior in 3.0.</span></span> <span data-ttu-id="e87e6-158">Zum Ändern des Verhaltens müssen Sie Warnungen konfigurieren, während Sie die Optionen für Ihren Kontext einrichten. Dies erfolgt in der Regel in `DbContext.OnConfiguring` oder in `Startup.cs`, wenn Sie ASP.NET Core verwenden.</span><span class="sxs-lookup"><span data-stu-id="e87e6-158">To change the behavior, you need to configure warnings while setting up the options for your context - typically in `DbContext.OnConfiguring`, or in `Startup.cs` if you're using ASP.NET Core.</span></span>

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder
        .UseSqlServer(@"Server=(localdb)\mssqllocaldb;Database=EFQuerying;Trusted_Connection=True;")
        .ConfigureWarnings(warnings => warnings.Throw(RelationalEventId.QueryClientEvaluationWarning));
}
```
